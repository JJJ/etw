"use strict";var _createClass=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(function(){var a=[].indexOf;jQuery(document).ready(function(o){return window.WC_Square_Payment_Form_Handler=(_createClass(t,[{key:"handle_checkout_page",value:function(){var e=this;return o(document.body).on("updated_checkout",function(){return e.set_payment_fields()}),o(document.body).on("updated_checkout",function(){return e.handle_saved_payment_methods()}),this.form.on("checkout_place_order_"+this.id,function(){return e.validate_payment_data()})}},{key:"handle_saved_payment_methods",value:function(){var e,t;if(t=this.id_dasherized,e=o("div.js-wc-"+t+"-new-payment-method-form"),o("input.js-wc-"+this.id_dasherized+"-payment-token").change(function(){return o("input.js-wc-"+t+"-payment-token:checked").val()?e.slideUp(200):e.slideDown(200)}).change(),o("input#createaccount").change(function(){var e;return e=o("input.js-wc-"+t+"-tokenize-payment-method").closest("p.form-row"),o(this).is(":checked")?(e.slideDown(),e.next().show()):(e.hide(),e.next().hide())}),!o("input#createaccount").is(":checked"))return o("input#createaccount").change()}},{key:"handle_pay_page",value:function(){var e=this;return this.set_payment_fields(),this.handle_saved_payment_methods(),this.form.submit(function(){if(o("#order_review input[name=payment_method]:checked").val()===e.id)return e.validate_payment_data()})}},{key:"handle_add_payment_method_page",value:function(){var e=this;return this.set_payment_fields(),this.form.submit(function(){if(o("#add_payment_method input[name=payment_method]:checked").val()===e.id)return e.validate_payment_data()})}},{key:"set_payment_fields",value:function(){return this.payment_form&&(this.log("Destroying payment form"),this.payment_form.destroy()),this.log("Building payment form"),this.payment_form=new SqPaymentForm(this.get_form_params()),this.payment_form.build()}},{key:"get_form_params",value:function(){var e,t,n,a,r=this;return e=o("#wc-"+this.id_dasherized+"-account-number-hosted"),n=o("#wc-"+this.id_dasherized+"-expiry-hosted"),t=o("#wc-"+this.id_dasherized+"-csc-hosted"),a=o("#wc-"+this.id_dasherized+"-postal-code-hosted"),{applicationId:this.application_id,cardNumber:{elementId:e.attr("id"),placeholder:e.data("placeholder")},expirationDate:{elementId:n.attr("id"),placeholder:n.data("placeholder")},cvv:{elementId:t.attr("id"),placeholder:t.data("placeholder")},postalCode:{elementId:a.attr("id"),placeholder:a.data("placeholder")},inputClass:"wc-"+this.id_dasherized+"-payment-field",inputStyles:this.input_styles,callbacks:{inputEventReceived:function(e){return r.handle_input_event(e)},cardNonceResponseReceived:function(e,t,n){return r.handle_response(e,t,n)},unsupportedBrowserDetected:function(){return r.handle_unsupported_browser()},paymentFormLoaded:function(){return r.handle_form_loaded()}}}}},{key:"handle_form_loaded",value:function(){if(this.log("Payment form loaded"),this.payment_form.setPostalCode(o("#billing_postcode").val()),o("form.checkout").length||o("#billing_postcode").val())return o(".wc-square-credit-card-card-postal-code-parent").addClass("hidden")}},{key:"handle_input_event",value:function(e){var t;if(t=o("#"+e.elementId),"cardBrandChanged"===e.eventType)return this.handle_card_brand_change(e.cardBrand,t)}},{key:"handle_card_brand_change",value:function(e,t){var n;return this.log("Card brand changed to "+e),t.attr("class",function(e,t){return t.replace(/(^|\s)card-type-\S+/g,"")}),n="plain",null!=e&&"unknown"!==e||(e=""),null!=this.square_card_types[e]&&(e=this.square_card_types[e]),n=e&&a.call(this.enabled_card_types,e)<0?"invalid":e,o("input[name=wc-"+this.id_dasherized+"-card-type]").val(e),t.addClass("card-type-"+n)}},{key:"validate_payment_data",value:function(){return!(this.form.is(".processing")||(this.has_nonce()?(this.log("Payment nonce present, placing order"),0):!o(".payment_method_"+this.id).find(".js-wc-square-credit-card-payment-token:checked").val()&&(this.log("Requesting payment nonce"),this.block_ui(),this.payment_form.requestCardNonce(),1)))}},{key:"handle_response",value:function(e,t,n){var a;return e?this.handle_errors(e):t?(this.log("Card data received"),console.log(n),this.log_data(n,"response"),n.last_4&&o("input[name=wc-"+this.id_dasherized+"-last-four]").val(n.last_4),n.exp_month&&o("input[name=wc-"+this.id_dasherized+"-exp-month]").val(n.exp_month),n.exp_year&&o("input[name=wc-"+this.id_dasherized+"-exp-year]").val(n.exp_year),n.billing_postal_code&&o("input[name=wc-square-credit-card-payment-postcode]").val(n.billing_postal_code),o("input[name=wc-"+this.id_dasherized+"-payment-nonce]").val(t),this.form.submit()):(a="Nonce is missing from the Square response",this.log(a,"error"),this.log_data(a,"response"),this.handle_errors())}},{key:"handle_unsupported_browser",value:function(){}},{key:"handle_errors",value:function(e){var a,r=this,i=0<arguments.length&&void 0!==e?e:null;return this.log("Error getting payment data","error"),a=[],i&&(console.error(i),o(i).each(function(e,t){var n;return"UNSUPPORTED_CARD_BRAND"===(n=t.type)||"VALIDATION_ERROR"===n?a.push(t.message):r.log_data(i,"response")})),0===a.length&&a.push(this.general_error),this.render_errors(a),this.unblock_ui()}},{key:"render_errors",value:function(e){return o(".woocommerce-error, .woocommerce-message").remove(),this.form.prepend('<ul class="woocommerce-error"><li>'+e.join("</li><li>")+"</li></ul>"),this.form.removeClass("processing").unblock(),this.form.find(".input-text, select").blur(),o("html, body").animate({scrollTop:this.form.offset().top-100},1e3)}},{key:"block_ui",value:function(){return this.form.block({message:null,overlayCSS:{background:"#fff",opacity:.6}})}},{key:"unblock_ui",value:function(){return this.form.unblock()}},{key:"has_nonce",value:function(){return o("input[name=wc-"+this.id_dasherized+"-payment-nonce]").val()}},{key:"log_data",value:function(e,t){var n;if(this.logging_enabled)return n={action:"wc_"+this.id+"_log_js_data",security:this.ajax_log_nonce,type:t,data:e},o.ajax({url:this.ajax_url,data:n})}},{key:"log",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:"notice";if(this.logging_enabled)return"error"===n?console.error("Square Error: "+e):console.log("Square: "+e)}}]),t);function t(e){if(_classCallCheck(this,t),this.set_payment_fields=this.set_payment_fields.bind(this),this.get_form_params=this.get_form_params.bind(this),this.handle_input_event=this.handle_input_event.bind(this),this.id=e.id,this.id_dasherized=e.id_dasherized,this.csc_required=e.csc_required,this.enabled_card_types=e.enabled_card_types,this.square_card_types=e.square_card_types,this.logging_enabled=e.logging_enabled,this.general_error=e.general_error,this.ajax_url=e.ajax_url,this.ajax_log_nonce=e.ajax_log_nonce,this.input_styles=e.input_styles,this.application_id=e.application_id,o("form.checkout").length)this.form=o("form.checkout"),this.handle_checkout_page();else if(o("form#order_review").length)this.form=o("form#order_review"),this.handle_pay_page();else{if(!o("form#add_payment_method").length)return void console.log("No payment form found!");this.form=o("form#add_payment_method"),this.handle_add_payment_method_page()}this.params=window.sv_wc_payment_gateway_payment_form_params,o(document.body).on("checkout_error",function(){return o("input[name=wc-square-credit-card-payment-nonce]").val("")}),o(document.body).on("click","#payment_method_"+this.id,function(){if(this.payment_form)return this.log("Recalculating payment form size"),this.payment_form.recalculateSize()})}})}).call(void 0);
//# sourceMappingURL=wc-square.min.js.map
