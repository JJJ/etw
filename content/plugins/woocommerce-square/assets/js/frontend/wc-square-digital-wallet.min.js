"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}();(function(){var e=[].indexOf;jQuery(document).ready(function(t){return window.WC_Square_Digital_Wallet_Handler=function(){function a(e){_classCallCheck(this,a),this.get_form_params=this.get_form_params.bind(this),this.get_payment_request=this.get_payment_request.bind(this),this.recalculate_totals=this.recalculate_totals.bind(this),this.process_digital_wallet_checkout=this.process_digital_wallet_checkout.bind(this),this.args=e,this.payment_request=e.payment_request,this.wallet="#wc-square-digital-wallet",this.buttons=".wc-square-wallet-buttons",0!==t(this.wallet).length&&(t(this.wallet).hide(),t(this.buttons).hide(),this.build_digital_wallet(),this.attach_page_events())}return _createClass(a,[{key:"build_digital_wallet",value:function(){var e=this;return this.block_ui(),this.get_payment_request().then(function(a){return e.payment_request=t.parseJSON(a),e.load_square_form(),e.unblock_ui()},function(a){return e.log("[Square] Could not build payment request. "+a.message,"error"),t(e.wallet).hide()})}},{key:"attach_page_events",value:function(){var e,a=this;return"product"===this.args.context?(e=t(".single_add_to_cart_button"),t("#wc-square-apple-pay, #wc-square-google-pay").on("click",function(t){return e.is(".disabled")?(t.stopImmediatePropagation(),void(e.is(".wc-variation-is-unavailable")?window.alert(wc_add_to_cart_variation_params.i18n_unavailable_text):e.is(".wc-variation-selection-needed")&&window.alert(wc_add_to_cart_variation_params.i18n_make_a_selection_text))):a.add_to_cart()}),t(document.body).on("woocommerce_variation_has_changed",function(){return a.build_digital_wallet()}),t(".quantity").on("input",".qty",function(){return a.build_digital_wallet()})):"cart"===this.args.context?t(document.body).on("updated_cart_totals",function(){return a.build_digital_wallet()}):"checkout"===this.args.context?t(document.body).on("updated_checkout",function(){return a.build_digital_wallet()}):void 0}},{key:"load_square_form",value:function(){return this.payment_form&&(this.log("[Square] Destroying digital wallet payment form"),this.payment_form.destroy()),this.log("[Square] Building digital wallet payment form"),this.payment_form=new SqPaymentForm(this.get_form_params()),this.payment_form.build()}},{key:"get_form_params",value:function(){var t,a=this;return t={applicationId:this.args.application_id,locationId:this.args.location_id,autobuild:!1,applePay:{elementId:"wc-square-apple-pay"},googlePay:{elementId:"wc-square-google-pay"},callbacks:{paymentFormLoaded:function(){return a.unblock_ui()},createPaymentRequest:function(){return a.create_payment_request()},methodsSupported:function(e,t){return a.methods_supported(e,t)},shippingContactChanged:function(e,t){return a.handle_shipping_address_changed(e,t)},shippingOptionChanged:function(e,t){return a.handle_shipping_option_changed(e,t)},cardNonceResponseReceived:function(e,t,n,r,i,o){return a.handle_card_nonce_response(e,t,n,r,i,o)}}},!1===this.payment_request.requestShippingAddress&&delete t.callbacks.shippingOptionChanged,e.call(this.args.hide_button_options,"google")>=0&&delete t.googlePay,e.call(this.args.hide_button_options,"apple")>=0&&delete t.applePay,t}},{key:"create_payment_request",value:function(){return this.payment_request}},{key:"methods_supported",value:function(e,a){return!0===e.applePay||!0===e.googlePay?(!0===e.applePay&&t("#wc-square-apple-pay").show(),!0===e.googlePay&&t("#wc-square-google-pay").show(),t(this.wallet).show()):this.log(a)}},{key:"get_payment_request",value:function(){var e=this;return new Promise(function(a,n){var r,i;return r={context:e.args.context,security:e.args.payment_request_nonce},"product"===e.args.context&&(i=e.get_product_data(),t.extend(r,i)),t.post(e.get_ajax_url("get_payment_request"),r,function(e){return e.success?a(e.data):n(e.data)})})}},{key:"handle_shipping_address_changed",value:function(e,t){var a;return a={context:this.args.context,shipping_contact:e.data,security:this.args.recalculate_totals_nonce},this.recalculate_totals(a).then(function(e){return t(e)},function(e){return t({error:"Bad Request"})})}},{key:"handle_shipping_option_changed",value:function(e,t){var a;return a={context:this.args.context,shipping_option:e.data.id,security:this.args.recalculate_totals_nonce},this.recalculate_totals(a).then(function(e){return t(e)},function(e){return t({error:"Bad Request"})})}},{key:"handle_card_nonce_response",value:function(e,t,a,n,r,i){var o,s=this;return e?this.render_errors(e):t?(this.block_ui(),o={action:"",_wpnonce:this.args.process_checkout_nonce,billing_first_name:n.givenName?n.givenName:"",billing_last_name:n.familyName?n.familyName:"",billing_company:"",billing_email:r.email?r.email:"",billing_phone:r.phone?r.phone:"",billing_country:n.country?n.country.toUpperCase():"",billing_address_1:n.addressLines&&n.addressLines[0]?n.addressLines[0]:"",billing_address_2:n.addressLines&&n.addressLines[1]?n.addressLines[1]:"",billing_city:n.city?n.city:"",billing_state:n.region?n.region:"",billing_postcode:n.postalCode?n.postalCode:"",shipping_first_name:r.givenName?r.givenName:"",shipping_last_name:r.familyName?r.familyName:"",shipping_company:"",shipping_country:r.country?r.country.toUpperCase():"",shipping_address_1:r.addressLines&&r.addressLines[0]?r.addressLines[0]:"",shipping_address_2:r.addressLines&&r.addressLines[1]?r.addressLines[1]:"",shipping_city:r.city?r.city:"",shipping_state:r.region?r.region:"",shipping_postcode:r.postalCode?r.postalCode:"",shipping_method:[i?i.id:null],order_comments:"",payment_method:"square_credit_card",ship_to_different_address:1,terms:1,"wc-square-credit-card-payment-nonce":t,"wc-square-credit-card-last-four":a.last_4?a.last_4:null,"wc-square-credit-card-exp-month":a.exp_month?a.exp_month:null,"wc-square-credit-card-exp-year":a.exp_year?a.exp_year:null,"wc-square-credit-card-payment-postcode":a.billing_postal_code?a.billing_postal_code:null,"wc-square-digital-wallet-type":a.digital_wallet_type},"GOOGLE_PAY"===a.digital_wallet_type&&(n.givenName&&(o.billing_first_name=n.givenName.split(" ").slice(0,1).join(" "),o.billing_last_name=n.givenName.split(" ").slice(1).join(" ")),r.givenName&&(o.shipping_last_name=r.givenName.split(" ").slice(0,1).join(" "),o.shipping_last_name=r.givenName.split(" ").slice(1).join(" "))),!o.billing_phone&&n.phone&&(o.billing_phone=n.phone),this.process_digital_wallet_checkout(o).then(function(e){return window.location=e.redirect},function(e){return s.log(e,"error"),s.render_errors_html(e.messages)})):this.render_errors(this.args.general_error)}},{key:"recalculate_totals",value:function(e){var a=this;return new Promise(function(n,r){return t.post(a.get_ajax_url("recalculate_totals"),e,function(e){return e.success?n(e.data):r(e.data)})})}},{key:"get_product_data",value:function(){var e,a;return a=t(".single_add_to_cart_button").val(),e={},t(".single_variation_wrap").length&&(a=t(".single_variation_wrap").find('input[name="product_id"]').val(),t(".variations_form").length&&t(".variations_form").find(".variations select").each(function(a,n){var r,i;return r=t(n).data("attribute_name")||t(n).attr("name"),i=t(n).val()||"",e[r]=i})),{product_id:a,quantity:t(".quantity .qty").val(),attributes:e}}},{key:"add_to_cart",value:function(){var e,a,n=this;return e={security:this.args.add_to_cart_nonce},a=this.get_product_data(),t.extend(e,a),t.post(this.get_ajax_url("add_to_cart"),e,function(a){return a.error?window.alert(a.data):(e=t.parseJSON(a.data),n.payment_request=e.payment_request,n.args.payment_request_nonce=e.payment_request_nonce,n.args.add_to_cart_nonce=e.add_to_cart_nonce,n.args.recalculate_totals_nonce=e.recalculate_totals_nonce,n.args.process_checkout_nonce=e.process_checkout_nonce)})}},{key:"process_digital_wallet_checkout",value:function(e){var a=this;return new Promise(function(n,r){return t.post(a.get_ajax_url("process_checkout"),e,function(e){return"success"===e.result?n(e):r(e)})})}},{key:"get_ajax_url",value:function(e){return this.args.ajax_url.replace("%%endpoint%%","square_digital_wallet_"+e)}},{key:"render_errors_html",value:function(e){var a;return t(".woocommerce-error, .woocommerce-message").remove(),(a="product"===this.args.context?t(".product"):t(".shop_table.cart").closest("form")).before(e),this.unblock_ui(),t("html, body").animate({scrollTop:a.offset().top-100},1e3)}},{key:"render_errors",value:function(e){var t;return t='<ul class="woocommerce-error"><li>'+e.join("</li><li>")+"</li></ul>",this.render_errors_html(t)}},{key:"block_ui",value:function(){return t(this.buttons).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})}},{key:"unblock_ui",value:function(){return t(this.buttons).unblock()}},{key:"log",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"notice";if(this.args.logging_enabled)return"error"===t?console.error(e):console.log(e)}}]),a}()})}).call(void 0);
//# sourceMappingURL=wc-square-digital-wallet.min.js.map